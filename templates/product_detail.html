{% extends "base.html" %}

{% block title %}{{ product.name }} - Amma's Kitchen{% endblock %}

{% block content %}
<section class="pt-5 pb-5" style="background:#fff;">
  <div class="container" style="margin-top:48px; margin-bottom:64px;">
    <div class="row gx-5 gy-5">
      <div class="col-lg-6 mb-4 mb-lg-0">
        <div class="border rounded-4 p-3 mb-3 d-flex flex-column align-items-center bg-white shadow">
          <div id="productGallery" class="carousel slide w-100" data-bs-ride="carousel">
            <div class="carousel-inner rounded-4">
              {% for img in product.images %}
              <div class="carousel-item {% if loop.first %}active{% endif %}">
                <img src="{{ url_for('static', filename=img.url) }}" class="d-block w-100" style="height:370px; object-fit:cover;" alt="{{ product.name }}">
              </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#productGallery" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#productGallery" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
          </div>
          <div class="d-flex mt-2 gap-2 justify-content-center">
            {% for img in product.images[:3] %}
            <img src="{{ url_for('static', filename=img.url) }}" class="rounded border" style="width:55px; height:55px; object-fit:cover; cursor:pointer" onclick="document.querySelector('#productGallery .carousel-item.active').classList.remove('active');document.querySelector('#productGallery .carousel-item:nth-child({{loop.index}})').classList.add('active');">
            {% endfor %}
          </div>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="ps-lg-3">
          <h2 class="title mb-2 fw-bold" style="color:#FF9800;" data-i18n="product_{{ product.id }}">{{ product.name }}</h2>
          
          <div class="mb-3">
            <span class="badge bg-success me-2" data-i18n="product_page.delivery_time">2-3 Days Delivery</span>
            <span class="badge bg-info text-dark me-2" data-i18n="product_page.home_delivery">₹50 Home Delivery</span>
            <span class="badge" style="background: linear-gradient(90deg, #FFB300, #FF1744); color:white;" data-i18n="product_page.discount">Big Discount</span>
            <span class="badge bg-primary text-white me-2" data-i18n="product_page.refund">7 Days Refund</span>
          </div>
          
          <div class="mb-3 d-flex align-items-center">
            <span style="color:#FFA500; font-weight: bold" class="fs-5">
              <svg width="22" height="22" class="mb-1"><use xlink:href="#star-solid"></use></svg> {{ product.rating }}
            </span>
            <span class="ms-4 text-muted">
                <i class="bi bi-bag"></i> {{ product.stock }} <span data-i18n="product_page.orders">orders</span>
            </span>
            <span class="ms-4 text-success" data-i18n="product_page.in_stock">In stock</span>
          </div>

          <div class="mt-3 mb-3">
            <label for="weightSelect" class="fw-semibold mb-1" style="color:#1976D2;" data-i18n="product_page.select_qty">Select Quantity:</label>
            <select class="form-select fw-bold" id="weightSelect" style="max-width:150px; display:inline-block;">
              <option value="50">50g</option>
              <option value="100">100g</option>
              <option value="250">250g</option>
              <option value="500">500g</option>
              <option value="1000">1kg</option>
            </select>
          </div>

          <div class="mb-3" id="dynamicPricing">
            <span class="fs-3 fw-bold" id="priceDisplay" style="color:#D32F2F;">₹{{ "%.2f"|format(product.price) }}</span>
            <span class="fs-6 text-muted">/<span id="weightLabel">50g</span></span>
            <s class="text-muted ms-2" id="mrpDisplay">₹{{ "%.2f"|format(product.mrp) }}</s>
            <span class="badge ms-2" id="saveBadge" style="background:linear-gradient(90deg,#FF9800,#1976D2);color:white;">Save ₹{{ "%.0f"|format(product.mrp - product.price) }}</span>
          </div>

          <div class="mb-2">{{ product.description or "Freshly prepared, homemade with finest ingredients." }}</div>
          <hr />

          <form class="add-to-cart-form d-flex gap-2 align-items-center"
                id="addToCartForm"
                data-product-id="{{ product.id }}"
                data-product-name="{{ product.name }}"
                data-product-price="{{ product.price }}"
                data-base-price="{{ product.price }}"
                data-base-mrp="{{ product.mrp }}">
            <div class="input-group input-group-lg" style="width:160px;">
              <button type="button" class="btn btn-outline-warning rounded-pill btn-qty" data-action="decrease" style="font-size:1.4rem;">–</button>
              <input type="number" name="quantity" min="1" max="{{ product.stock }}" value="1" class="form-control text-center qty-input" style="font-size:1.4rem;">
              <button type="button" class="btn btn-outline-warning rounded-pill btn-qty" data-action="increase" style="font-size:1.4rem;">+</button>
            </div>
            <button type="submit" class="btn btn-warning fw-bold px-4 shadow ms-2" style="background:linear-gradient(90deg,#FFB300,#FF9800);border:0;">
              <i class="fa fa-shopping-basket me-1"></i> <span data-i18n="buttons.add_cart">Add to Cart</span>
            </button>
            <a href="#" class="btn btn-outline-danger px-3 py-2 rounded-pill ms-2" style="font-weight:bolder;">
              <i class="fa fa-heart"></i> <span data-i18n="buttons.save">Save</span>
            </a>
          </form>

          <div class="my-4">
            <strong data-i18n="product_page.accepted_payments">Accepted Payments:</strong>
            <img src="{{ url_for('static', filename='images/payments/visa.png') }}" style="height:28px;">
            <img src="{{ url_for('static', filename='images/payments/mastercard.png') }}" style="height:28px;">
            <img src="{{ url_for('static', filename='images/payments/rupay.png') }}" style="height:28px;">
            <img src="{{ url_for('static', filename='images/payments/gpay.png') }}" style="height:28px;">
          </div>
          <div class="fs-6 text-muted"><i class="bi bi-truck"></i> <span data-i18n="product_page.delivery_info">Delivery in 2-3 days | Rs.50 extra for home.</span></div>
        </div>
      </div>
    </div>

    <div class="row mt-5 mb-5">
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-stretch gap-4">
            <div class="flex-shrink-0 text-center" style="min-width:160px;">
                <img src="{{ url_for('static', filename=product.images[0].url) }}" class="img-fluid rounded-3 shadow" alt="{{ product.name }}" style="max-width:125px; max-height:125px;">
                <div class="badge bg-warning text-dark mt-2 mb-3 fw-bold fs-6 border border-2 border-white shadow" data-i18n="product_page.homemade_badge">100% Homemade</div>
            </div>
            <div class="flex-grow-1">
                <h5 class="fw-bold mb-2" style="color:#FF9800;">
                    <span data-i18n="product_page.homemade_title_prefix">Homemade</span> 
                    <span data-i18n="product_{{ product.id }}">{{ product.name }}</span>
                </h5>
                <p class="mb-2 fs-6">{{ product.description or "Prepared freshly in small batches for authentic taste. No preservatives, full of flavor, just like home." }}</p>
                <div class="mb-3">
                <span class="badge bg-success me-2 mb-2" data-i18n="product_page.authentic">Authentic Recipe</span>
                <span class="badge bg-primary me-2 mb-2" data-i18n="product_page.handpicked">Handpicked Ingredients</span>
                <span class="badge bg-info text-dark mb-2" data-i18n="product_page.prepared">Prepared on Order</span>
                </div>
                <div class="row g-3 mb-2">
                <div class="col-12 col-md-6 fs-6 mb-1">
                    <span class="fw-bold" style="color:#1976D2;" data-i18n="product_page.main_ingredients">Main Ingredients:</span>
                    <span>
                    {% if product.ingredients %}
                        {{ product.ingredients | join(', ') }}
                    {% else %}
                        Chili, coriander, turmeric, home-dried curry leaves
                    {% endif %}
                    </span>
                </div>
                <div class="col-12 col-md-6 fs-6 mb-1">
                    <span class="fw-bold" style="color:#D32F2F;" data-i18n="product_page.best_with">Best with:</span>
                    <span>
                    {% if product.suggested_uses %}
                        {{ product.suggested_uses | join(', ') }}
                    {% else %}
                        Rice, Dosa, Idli, Sambar, Rasam, Curries
                    {% endif %}
                    </span>
                </div>
                </div>
                <div class="d-flex flex-wrap mt-3 gap-3">
                <div class="border rounded-3 p-3 bg-white shadow-sm flex-fill" style="min-width:165px;">
                    <div class="fw-bold" style="color:#FF9800;"><i class="bi bi-fire"></i> <span data-i18n="product_page.fresh_spice">Fresh Spice</span></div>
                    <div class="text-muted small" data-i18n="product_page.fresh_spice_desc">Family recipe with carefully selected ingredients, ground and roasted in small batches.</div>
                </div>
                <div class="border rounded-3 p-3 bg-white shadow-sm flex-fill" style="min-width:165px;">
                    <div class="fw-bold" style="color:#1976D2;"><i class="bi bi-box"></i> <span data-i18n="product_page.packed_fresh">Packed Fresh</span></div>
                    <div class="text-muted small" data-i18n="product_page.packed_fresh_desc">Every order is packed on the same day for max freshness and aroma.</div>
                </div>
                <div class="border rounded-3 p-3 bg-white shadow-sm flex-fill" style="min-width:165px;">
                    <div class="fw-bold" style="color:#D32F2F;"><i class="bi bi-heart"></i> <span data-i18n="product_page.ammas_touch">Amma's Touch</span></div>
                    <div class="text-muted small" data-i18n="product_page.ammas_touch_desc">Cooked & blended with love, bringing home-style taste to your kitchen!</div>
                </div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <div class="mt-5 pt-4">
    <h4 class="fw-bold mb-3 ms-2" style="color: #ff9800;" data-i18n="product_page.you_may_like">You may also like</h4>
    <div class="row g-4">
        {% for other in recommendations %}
        <div class="col-6 col-md-3">
            <div class="card shadow h-100 rounded-4">
            <a href="{{ url_for('product_detail', product_id=other.id) }}">
                <img src="{{ url_for('static', filename=other.image_url) }}" class="card-img-top" alt="{{ other.name }}" style="height:240px; object-fit:cover;">
            </a>
            <div class="card-body py-3 px-2">
                <h6 class="card-title fw-bold mb-1" style="font-size:1rem;" data-i18n="product_{{ other.id }}">{{ other.name }}</h6>
                <div class="fw-bold" style="color:#D32F2F; font-size:1.15rem; letter-spacing:2px;">₹{{ other.price }}</div>
            </div>
            </div>
        </div>
        {% endfor %}
    </div>
    </div>
  </div>
</section>

<script>
const weightOpts = [50, 100, 250, 500, 1000];
const pricePerStep = 30;    // You can adjust as needed
const mrpPerStep = 40;
function updateDynamicPricing() {
  const sel = document.getElementById('weightSelect');
  const idx = sel ? sel.selectedIndex : 0;
  const chosen = weightOpts[idx] || weightOpts[0];
  const form = document.getElementById('addToCartForm');
  const basePrice = parseFloat(form.dataset.basePrice);
  const baseMrp = parseFloat(form.dataset.baseMrp);
  const price = basePrice + idx * pricePerStep;
  const mrp = baseMrp + idx * mrpPerStep;
  const save = mrp - price;
  
  // NOTE: We generally avoid translating dynamic numbers/currencies via i18n keys
  document.getElementById('priceDisplay').textContent = `₹${price.toFixed(2)}`;
  document.getElementById('weightLabel').textContent = `${chosen}g`;
  document.getElementById('mrpDisplay').textContent = `₹${mrp.toFixed(2)}`;
  
  // Update the Save badge text manually if needed, or leave as simple format
  // If you want "Save" to be translated here, you'd need to fetch the current language via i18next.language
  // and pick the correct word.
  document.getElementById('saveBadge').textContent = `Save ₹${save}`;
  
  form.dataset.productPrice = price;
}
document.getElementById('weightSelect').addEventListener('change', updateDynamicPricing);
document.addEventListener("DOMContentLoaded", updateDynamicPricing);

document.querySelectorAll('.btn-qty').forEach(function(btn){
  btn.addEventListener('click', function(){
    const input = btn.parentElement.querySelector('.qty-input');
    let val = parseInt(input.value) || 1;
    if (btn.dataset.action === 'increase') input.value = val + 1;
    else input.value = Math.max(1, val - 1);
  });
});
</script>
{% endblock %}