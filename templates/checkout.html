{% extends "base.html" %}
{% block title %}Checkout - Amma's Kitchen{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
    :root {
        --saffron: #ffab00;
        --spice: #7952b3;
        --spice-dark: #45287c;
        --light-bg: #faf7ff;
        --shadow: 0 4px 18px rgba(30,16,64,0.07), 0 1.5px 4px rgba(0,0,0,0.04);
    }

    body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }

    .checkout-container {
        max-width: 720px;
        margin: 0 auto;
    }

    /* Gradient Text */
    .text-gradient {
        background: linear-gradient(90deg, #7952b3, #ff8d49);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 900;
        letter-spacing: -1px;
    }

    /* Summary Card (Top Row) */
    .summary-card {
        background: #ffffff;
        border-radius: 1.5rem;
        box-shadow: var(--shadow);
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: space-around;
        text-align: center;
        border: 1px solid #eee;
    }
    .summary-box span {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--spice);
        display: block;
        line-height: 1.2;
    }
    .summary-box .amount { color: #D32F2F; }
    .summary-box div { font-size: 0.85rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }

    /* Order List */
    .order-list-group {
        background: #fff;
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .order-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px dashed #eee;
    }
    .order-item:last-child { border-bottom: none; }
    .order-item-details { flex: 1; font-weight: 600; color: #333; }
    
    /* Coupon Box */
    .coupon-box {
        background: #fff8e1;
        border: 1px solid #ffe082;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .btn-coupon {
        background: #ffab00;
        color: #000;
        font-weight: 700;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        transition: 0.2s;
    }
    .btn-coupon:hover { background: #ff9100; }

    /* Pay Button */
    .pay-btn {
        width: 100%;
        font-size: 1.2rem;
        font-weight: 800;
        border-radius: 12px;
        padding: 1rem;
        background: linear-gradient(90deg, #7952b3, #6f42c1);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(121, 82, 179, 0.3);
        transition: transform 0.2s;
        margin-top: 1rem;
    }
    .pay-btn:hover { transform: translateY(-2px); }
    .pay-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

    /* Dark Mode Toggle */
    .toggle-darkmode {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: var(--spice);
        font-size: 1.5rem;
    }
</style>

<section class="py-5">
  <div class="container checkout-container position-relative">
    
    <div class="text-center mb-5">
        <h2 class="display-5 fw-bold text-gradient">Checkout</h2>
        <p class="text-muted">Secure Payment via Razorpay</p>
    </div>

    <div class="summary-card">
      <div class="summary-box">
        <span id="summary-products">0</span>
        <div>Items</div>
      </div>
      <div class="summary-box">
        <span id="summary-qty">0</span>
        <div>Total Qty</div>
      </div>
      <div class="summary-box">
        <span class="amount" id="summary-total">₹0.00</span>
        <div>Total Price</div>
      </div>
    </div>

    <div class="coupon-box">
      <i class="fa fa-tag text-warning fs-5"></i>
      <input type="text" id="couponInput" class="form-control border-0 bg-transparent shadow-none fw-bold" placeholder="ENTER COUPON CODE">
      <button type="button" class="btn-coupon" id="applyCouponBtn">APPLY</button>
    </div>
    <div id="couponStatus" class="mb-3 ps-2 small fw-bold"></div>

    <div class="order-list-group">
        <h5 class="fw-bold mb-3 border-bottom pb-2">Order Details</h5>
        <div id="order-details-list">
            <div class="text-center py-4">
                <i class="fa fa-spinner fa-spin text-muted"></i> Loading cart...
            </div>
        </div>
    </div>

    <div class="text-center mb-3">
        <span class="badge bg-light text-dark border p-2">
            <i class="fa fa-lock text-success me-1"></i> 100% Secure SSL Payment
        </span>
    </div>

    <button type="button" class="pay-btn" id="payButton">
        PAY ₹<span id="pay-amount">0.00</span>
    </button>

  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>

<script>
// 1. Initialize Cart & Variables
let cart = JSON.parse(localStorage.getItem('cart') || '{}');
const validCoupons = {"YUMMY30": 0.3, "WELCOME10": 0.1};
let currentTotal = 0;

// 2. Display Cart Function
function updateCheckoutDisplay() {
  let total = 0, totalQty = 0, orderListHTML = '';
  
  // Redirect if empty
  if (Object.keys(cart).length === 0) {
      document.getElementById('order-details-list').innerHTML = '<div class="text-center py-4 text-muted">Your cart is empty. <a href="{{ url_for("index") }}">Go Shop</a></div>';
      document.getElementById('payButton').disabled = true;
      return;
  }

  for(const key in cart) {
    const item = cart[key];
    const itemTotal = item.price * item.quantity;
    total += itemTotal;
    totalQty += item.quantity;
    
    orderListHTML += `
      <div class="order-item">
        <div class="order-item-details">
            ${item.name} <span class="text-muted small">x ${item.quantity}</span>
        </div>
        <span class="fw-bold">₹${itemTotal.toFixed(2)}</span>
      </div>`;
  }
  
  // Check for stored discount in logic (optional, for now just calc raw)
  currentTotal = total.toFixed(2); 

  // Update UI
  document.getElementById('order-details-list').innerHTML = orderListHTML;
  document.getElementById('summary-products').textContent = Object.keys(cart).length;
  document.getElementById('summary-qty').textContent = totalQty;
  document.getElementById('summary-total').textContent = `₹${currentTotal}`;
  document.getElementById('pay-amount').textContent = currentTotal;
}

// Initial Run
updateCheckoutDisplay();

// 3. Coupon Logic
document.getElementById('applyCouponBtn').onclick = function(){
  let code = document.getElementById('couponInput').value.trim().toUpperCase();
  let statusEl = document.getElementById('couponStatus');
  
  if(validCoupons[code]) {
    let discount = validCoupons[code];
    let originalTotal = parseFloat(document.getElementById('summary-total').textContent.replace('₹',''));
    
    // Apply Discount
    let discountedTotal = (originalTotal * (1 - discount)).toFixed(2);
    currentTotal = discountedTotal;
    
    // Update UI
    document.getElementById('pay-amount').textContent = currentTotal;
    
    statusEl.innerHTML = `<span class="text-success"><i class="fa fa-check-circle"></i> Coupon Applied! Saved ${Math.round(discount*100)}%</span>`;
    this.disabled = true;
    this.innerHTML = "APPLIED";
  } else {
    statusEl.innerHTML = `<span class="text-danger"><i class="fa fa-times-circle"></i> Invalid Coupon Code</span>`;
  }
};

// 4. Razorpay Payment Logic
document.getElementById('payButton').onclick = async function(e) {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fa fa-circle-notch fa-spin"></i> Processing...';

    try {
        // Step A: Create Order on Backend
        const response = await fetch('/create_order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ amount: currentTotal })
        });
        
        // Handle Unauthorized (Not Logged In)
        if (response.status === 401) {
            window.location.href = "{{ url_for('login') }}";
            return;
        }

        const orderData = await response.json();
        if(orderData.error) throw new Error(orderData.error);

        // Step B: Configure Razorpay
        const options = {
            "key": "{{ key_id }}", // Key from Flask
            "amount": orderData.amount,
            "currency": "INR",
            "name": "Amma's Kitchen",
            "description": "Delicious Food Order",
            "image": "{{ url_for('static', filename='images/logo1.png') }}",
            "order_id": orderData.id, 
            "handler": async function (response){
                // Step C: Verify Payment
                btn.innerHTML = 'Verifying...';
                
                const verifyRes = await fetch('/verify_payment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature,
                        cart_data: cart 
                    })
                });
                
                const verifyData = await verifyRes.json();
                
                if(verifyData.status === 'success') {
                    // Success!
                    btn.className = "pay-btn bg-success";
                    btn.innerHTML = '<i class="fa fa-check"></i> Payment Successful!';
                    
                    // Clear Cart & Redirect
                    localStorage.removeItem('cart');
                    setTimeout(() => { window.location.href = "{{ url_for('profile') }}"; }, 2000);
                } else {
                    alert("Verification Failed. Please contact support.");
                    btn.disabled = false;
                    btn.innerHTML = `PAY ₹${currentTotal}`;
                }
            },
            "prefill": {
                "name": "{{ session.get('user_name', '') }}",
                "email": "{{ session.get('user_email', '') }}"
            },
            "theme": { "color": "#7952b3" }
        };

        const rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response){
            alert("Payment Failed: " + response.error.description);
            btn.disabled = false;
            btn.innerHTML = `PAY ₹${currentTotal}`;
        });
        rzp1.open();

    } catch (error) {
        console.error(error);
        alert('Could not initiate payment. Please try again.');
        btn.disabled = false;
        btn.innerHTML = `PAY ₹${currentTotal}`;
    }
};
</script>
{% endblock %}