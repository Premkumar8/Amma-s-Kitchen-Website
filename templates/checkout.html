{% extends "base.html" %}
{% block title %}Checkout - Amma's Kitchen{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
    /* ... (Your existing styles remain unchanged) ... */
    :root { --saffron: #ffab00; --spice: #7952b3; --light-bg: #faf7ff; --shadow: 0 4px 18px rgba(30,16,64,0.07); }
    body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
    .checkout-container { max-width: 720px; margin: 0 auto; }
    .summary-card { background: #fff; border-radius: 1.5rem; padding: 1.5rem; display: flex; justify-content: space-around; text-align: center; border: 1px solid #eee; margin-bottom: 2rem; box-shadow: var(--shadow); }
    .summary-box span { font-size: 1.8rem; font-weight: 700; color: var(--spice); display: block; }
    .info-card { background: #fff; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #f0f0f0; box-shadow: var(--shadow); }
    .order-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #eee; }
    .coupon-box { background: #fff8e1; border: 1px solid #ffe082; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; }
    .pay-btn { width: 100%; font-size: 1.2rem; font-weight: 800; border-radius: 12px; padding: 1rem; background: linear-gradient(90deg, #7952b3, #6f42c1); color: white; border: none; margin-top: 1rem; transition: 0.2s; }
    .pay-btn:disabled { background: #ccc; cursor: not-allowed; }
    .address-display, .address-form { display: none; }
    .visible { display: block; }
</style>

<section class="py-5">
  <div class="container checkout-container">
    
    <div class="text-center mb-5">
        <h2 class="display-5 fw-bold" style="color: var(--spice);">Checkout</h2>
        <p class="text-muted">Secure Payment via Razorpay</p>
    </div>

    <div class="summary-card">
      <div class="summary-box"><span id="summary-products">0</span><div>Items</div></div>
      <div class="summary-box"><span id="summary-qty">0</span><div>Total Qty</div></div>
      <div class="summary-box"><span class="amount" id="summary-total">₹0.00</span><div>Total Price</div></div>
    </div>

    <div class="info-card">
        <h5 class="fw-bold mb-3 border-bottom pb-2"><i class="fa fa-truck text-danger me-2"></i>Delivery Details</h5>
        
        <div id="savedAddressView" class="address-display {% if user.address1 and user.phone %}visible{% endif %}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="mb-1 fw-bold">{{ user.name }}</p>
                    <p class="text-muted mb-1 small"><i class="fa fa-phone me-1"></i> <span id="displayPhone">{{ user.phone }}</span></p>
                    <p class="text-muted mb-2 small"><i class="fa fa-map-marker-alt me-1"></i> <span id="displayAddrText">{{ user.address1 }}{% if user.address2 %}, {{ user.address2 }}{% endif %}</span></p>
                </div>
                <button class="btn btn-sm btn-light border" onclick="editAddress()"><i class="fa fa-pen"></i> Edit</button>
            </div>
        </div>

        <div id="addressFormView" class="address-form {% if not user.address1 or not user.phone %}visible{% endif %}">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="small text-muted fw-bold">Mobile Number *</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 text-muted">+91</span>
                        <input type="tel" id="phone" class="form-control border-start-0 ps-0" placeholder="9876543210" value="{{ user.phone or '' }}" maxlength="10">
                    </div>
                </div>
            </div>
            
            <div class="mb-2">
                <label class="small text-muted fw-bold">Street Address / Flat No *</label>
                <input type="text" id="addr1" class="form-control" placeholder="e.g. 123 Main St, Apt 4B" value="{{ user.address1 or '' }}">
            </div>
            <div class="mb-3">
                <label class="small text-muted fw-bold">Area / Landmark (Optional)</label>
                <input type="text" id="addr2" class="form-control" placeholder="e.g. Near City Park" value="{{ user.address2 or '' }}">
            </div>
            <button class="btn btn-dark w-100 fw-bold" onclick="saveAddress()" id="saveAddrBtn">SAVE & DELIVER HERE</button>
        </div>
    </div>

    <div class="info-card">
        <h5 class="fw-bold mb-3 border-bottom pb-2">Order Summary</h5>
        <div id="order-details-list">
            <div class="text-center py-4"><i class="fa fa-spinner fa-spin text-muted"></i> Loading...</div>
        </div>
    </div>

    <div class="coupon-box">
      <i class="fa fa-tag text-warning fs-5"></i>
      <input type="text" id="couponInput" class="form-control border-0 bg-transparent shadow-none fw-bold" placeholder="ENTER COUPON CODE">
      <button type="button" class="btn btn-warning text-white fw-bold px-3 py-1 rounded-pill" id="applyCouponBtn">APPLY</button>
    </div>
    <div id="couponStatus" class="mb-3 ps-2 small fw-bold"></div>

    <button type="button" class="pay-btn" id="payButton">
        PAY ₹<span id="pay-amount">0.00</span>
    </button>

  </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/confetti-js@0.0.18/dist/index.min.js"></script>

<script>
// 1. Initialize
let cart = JSON.parse(localStorage.getItem('cart') || '{}');
const validCoupons = {"YUMMY30": 0.3, "WELCOME10": 0.1};
let currentTotal = 0;

// FIX 1: Robust check for existing details (Handles 'None' or empty strings correctly)
// We use the 'or' operator in Jinja to ensure we get an empty string if the value is None
let hasDetails = "{{ user.address1 or '' }}" !== "" && "{{ user.phone or '' }}" !== ""; 

// 2. Display Cart
function updateCheckoutDisplay() {
  let total = 0, qty = 0, html = '';
  
  // Check if cart is empty
  if (Object.keys(cart).length === 0) {
      document.getElementById('order-details-list').innerHTML = '<div class="text-center text-muted">Cart is empty. <a href="{{ url_for("index") }}">Shop Now</a></div>';
      document.getElementById('payButton').disabled = true;
      document.getElementById('payButton').innerText = "Cart is Empty";
      return;
  }

  for(const key in cart) {
    let item = cart[key];
    let itemTotal = item.price * item.quantity;
    total += itemTotal;
    qty += item.quantity;
    html += `<div class="order-item">
                <div><span class="fw-bold text-dark">${item.name}</span> <span class="text-muted small">x ${item.quantity}</span></div>
                <span class="fw-bold text-dark">₹${itemTotal.toFixed(2)}</span>
             </div>`;
  }
  
  currentTotal = total.toFixed(2);
  document.getElementById('order-details-list').innerHTML = html;
  document.getElementById('summary-qty').innerText = qty;
  document.getElementById('summary-total').innerText = '₹' + currentTotal;
  document.getElementById('pay-amount').innerText = currentTotal;
  
  checkPayButtonStatus();
}

function checkPayButtonStatus() {
    const payBtn = document.getElementById('payButton');
    
    // Enable button ONLY if Cart has items AND Address details exist
    if (Object.keys(cart).length > 0 && hasDetails) {
        payBtn.disabled = false;
        payBtn.style.opacity = "1";
        // Update the text to show the amount to pay
        payBtn.innerHTML = `PAY ₹${document.getElementById('pay-amount').innerText}`; 
    } else {
        payBtn.disabled = true;
        payBtn.style.opacity = "0.6";
        if (!hasDetails) {
            payBtn.innerHTML = "Complete Delivery Details";
        }
    }
}

// 3. ADDRESS & PHONE FUNCTIONS
function editAddress() {
    document.getElementById('savedAddressView').classList.remove('visible');
    document.getElementById('addressFormView').classList.add('visible');
    hasDetails = false; // Disable pay button while editing
    checkPayButtonStatus();
}

async function saveAddress() {
    const phone = document.getElementById('phone').value.trim();
    const addr1 = document.getElementById('addr1').value.trim();
    const addr2 = document.getElementById('addr2').value.trim();
    const btn = document.getElementById('saveAddrBtn');

    if (!phone || phone.length < 10) { alert("Please enter a valid 10-digit phone number."); return; }
    if (!addr1) { alert("Please enter a street address."); return; }

    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Saving...';
    
    try {
        const res = await fetch('/update_address', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ phone: phone, address1: addr1, address2: addr2 })
        });
        const data = await res.json();
        
        if (data.success) {
            // Update UI with new values
            document.getElementById('displayPhone').innerText = phone;
            document.getElementById('displayAddrText').innerText = addr1 + (addr2 ? `, ${addr2}` : '');
            
            document.getElementById('addressFormView').classList.remove('visible');
            document.getElementById('savedAddressView').classList.add('visible');
            
            hasDetails = true; // Mark as complete
            
            // FIX 2: UNCOMMENTED THIS LINE so the button updates!
            checkPayButtonStatus(); 
            
        } else {
            alert("Error saving details: " + data.message);
        }
    } catch (e) {
        console.error(e);
        alert("Server error. Please try again.");
    } finally {
        btn.innerHTML = 'SAVE & DELIVER HERE';
    }
}

// Init Load
updateCheckoutDisplay();

// 4. Coupon Logic
document.getElementById('applyCouponBtn').onclick = function(){
  let code = document.getElementById('couponInput').value.trim().toUpperCase();
  let status = document.getElementById('couponStatus');
  
  if(validCoupons[code]) {
    let discount = validCoupons[code];
    let original = parseFloat(currentTotal);
    currentTotal = (original * (1 - discount)).toFixed(2);
    
    // Update visual amount
    document.getElementById('pay-amount').innerText = currentTotal;
    
    status.innerHTML = `<span class="text-success"><i class="fa fa-check-circle"></i> Applied!</span>`;
    this.disabled = true;
    
    // Update button text with new price
    checkPayButtonStatus(); 
  } else {
    status.innerHTML = `<span class="text-danger">Invalid Code</span>`;
  }
};

// 5. Razorpay Payment Logic
document.getElementById('payButton').onclick = async function(e) {
    if (!hasDetails) { alert("Please complete your delivery details."); return; }
    
    const btn = this;
    const originalText = btn.innerHTML; // Save text to restore on failure
    btn.innerHTML = '<i class="fa fa-circle-notch fa-spin"></i> Processing...';
    btn.disabled = true;

    try {
        const response = await fetch('/create_order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ amount: currentTotal })
        });

        if (response.status === 401) { window.location.href = "{{ url_for('login') }}"; return; }

        const orderData = await response.json();
        if(orderData.error) throw new Error(orderData.error);

        const options = {
            "key": "{{ key_id }}",
            "amount": orderData.amount,
            "currency": "INR",
            "name": "Amma's Kitchen",
            "description": "Food Order",
            "image": "{{ url_for('static', filename='images/logo1.png') }}",
            "order_id": orderData.id, 
            "handler": async function (response){
                btn.innerHTML = 'Verifying...';
                const verifyRes = await fetch('/verify_payment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature,
                        cart_data: cart 
                    })
                });
                
                const verifyData = await verifyRes.json();
                if(verifyData.status === 'success') {
                    // Success Animation
                    let confettiSettings = { target: 'order-details-list' };
                    let confetti = new ConfettiGenerator(confettiSettings);
                    confetti.render();
                    
                    btn.className = 'pay-btn bg-success';
                    btn.innerHTML = '<i class="fa fa-check"></i> Order Placed!';
                    
                    // Clear Cart
                    localStorage.removeItem('cart');
                    
                    // Redirect
                    setTimeout(() => { window.location.href = "{{ url_for('profile') }}"; }, 2500);
                } else {
                    alert("Verification Failed.");
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            },
            "prefill": {
                "name": "{{ user.name }}",
                "email": "{{ user.email }}",
                "contact": document.getElementById('displayPhone').innerText // Use updated phone
            },
            "theme": { "color": "#7952b3" },
            "modal": {
                "ondismiss": function(){
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        };

        const rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response){
            alert("Payment Failed: " + response.error.description);
            fetch('/payment_failed', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    cart_data: cart,
                    reason: response.error.description,
                    payment_id: response.error.metadata ? response.error.metadata.payment_id : null,
                    payment_method: response.error.metadata ? response.error.metadata.payment_method : null
                })
            }).catch(err => console.error('Payment failure notify error', err));
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
        rzp1.open();

    } catch (error) {
        console.error(error);
        alert('Payment initiation failed: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
};
</script>
{% endblock %}
